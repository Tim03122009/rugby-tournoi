<!DOCTYPE html>
<html lang="fr">
<!-- 84.105.109.233.111 67.72.65.82.86.79.76.73.78 48.54.47.48.50.47.50.48.50.54 -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Rugby Tournoi</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèâ</text></svg>">
    <link rel="stylesheet" href="style.css">
    <!-- 30 36 2f 30 32 2f 32 30 32 36 -->
</head>
<body class="admin">
    <div class="page-wrapper">
    <header><h1>Configuration du Tournoi</h1></header>

    <nav class="admin-tabs">
        <div class="admin-tabs-list" id="tabsList"></div>
        <div class="admin-tabs-actions">
            <button type="button" class="btn-sm btn-add-cat" id="btnAddCat">+ Nouvelle cat√©gorie</button>
        </div>
    </nav>

    <div id="tabContent" class="admin-tab-content">
        <div id="configCard" class="card">
            <div class="card-toolbar">
                <span>Templates rapides</span>
                <button type="button" class="btn-sm" data-tpl="4">4 √©quipes</button>
                <button type="button" class="btn-sm" data-tpl="6">6 √©quipes</button>
                <button type="button" class="btn-sm" data-tpl="8">8 √©quipes</button>
            </div>

            <label>Nombre de terrains</label>
            <input type="number" id="terrains" value="2" min="1">

            <label>√âquipes (une par ligne)</label>
            <textarea id="equipes" rows="6" placeholder="√âquipe A&#10;√âquipe B&#10;√âquipe C&#10;√âquipe D"></textarea>

            <label>Arbitres (un par ligne)</label>
            <textarea id="arbitres" rows="3" placeholder="Marc&#10;Sophie"></textarea>

            <label>Dur√©e du match</label>
            <input type="text" id="dureeMatch" value="10 min" placeholder="ex: 10 min">

            <div class="btn-group">
                <button id="btnPreview" class="btn-secondary">Pr√©visualiser</button>
                <button id="btnGenerer" class="btn-main">G√âN√âRER LE PLANNING</button>
            </div>

            <p class="hint">Chaque cat√©gorie a sa propre configuration (sauvegard√©e automatiquement). La r√©g√©n√©ration remplace le planning de cette cat√©gorie.</p>
        </div>

        <div id="urlsCard" class="card" style="display:none">
            <h3>URLs √† partager</h3>
            <p class="hint">Copiez ces liens pour les g√©rants, coaches et arbitres.</p>
            <div class="url-list">
                <div class="url-row"><span>G√©rant</span><code id="urlGerant"></code><button type="button" class="btn-copy" data-target="urlGerant">Copier</button></div>
                <div class="url-row"><span>Coach</span><code id="urlCoach"></code><button type="button" class="btn-copy" data-target="urlCoach">Copier</button></div>
                <div class="url-row"><span>Arbitre</span><code id="urlArbitre"></code><button type="button" class="btn-copy" data-target="urlArbitre">Copier</button></div>
            </div>
        </div>

        <div id="noCategoryState" class="card empty-state" style="display:none">
            <p>Aucune cat√©gorie. Cliquez sur ¬´ + Nouvelle cat√©gorie ¬ª pour commencer.</p>
        </div>

        <div class="admin-tab-actions" id="tabActions" style="display:none">
            <button type="button" class="btn-sm btn-delete-cat" id="btnDeleteCat">Supprimer cette cat√©gorie</button>
        </div>
    </div>

    <div id="previewModal" class="modal" style="display:none">
        <div class="modal-content">
            <h2>Pr√©visualisation</h2>
            <div id="previewBody"></div>
            <button type="button" class="btn-main" id="closePreview">Fermer</button>
        </div>
    </div>

    <div id="addCatModal" class="modal" style="display:none">
        <div class="modal-content">
            <h2>Nouvelle cat√©gorie</h2>
            <label>Nom de la cat√©gorie</label>
            <input type="text" id="newCatName" placeholder="ex: U10, U12, Minimes‚Ä¶">
            <div class="btn-group" style="margin-top:20px">
                <button type="button" class="btn-secondary" id="cancelAddCat">Annuler</button>
                <button type="button" class="btn-main" id="confirmAddCat">Cr√©er</button>
            </div>
        </div>
    </div>
    </div>

    <script type="module">
        const _=[84,105,109,233,111,32,67,72,65,82,86,79,76,73,78,32,108,101,32,48,54,47,48,50,47,50,48,50,54];void _;
        const _rd=(x)=>{if(Array.isArray(x))return x.map(c=>String.fromCharCode(c)).join('');if(typeof x==='string'){const h=x.replace(/[\s.]/g,'').match(/.{1,2}/g);if(h&&/^[0-9a-fA-F]+$/.test(x.replace(/[\s.]/g,'')))return h.map(b=>String.fromCharCode(parseInt(b,16))).join('');try{return atob(x)}catch(e){}}return'';};
        import { genererTournoi, previewTournoi } from './js/algo.js';
        import { db, ref, onValue, set, remove } from './js/database.js';
        import { slugify } from './js/categories.js';

        const CATEGORY_LIST_REF = ref(db, 'tournoi/categoryList');
        const tpls = {
            4: { equipes: "√âquipe A\n√âquipe B\n√âquipe C\n√âquipe D", terrains: 2 },
            6: { equipes: "√âquipe A\n√âquipe B\n√âquipe C\n√âquipe D\n√âquipe E\n√âquipe F", terrains: 2 },
            8: { equipes: "√âquipe A\n√âquipe B\n√âquipe C\n√âquipe D\n√âquipe E\n√âquipe F\n√âquipe G\n√âquipe H", terrains: 2 }
        };

        let categories = {};
        let currentCatId = null;

        function renderTabs() {
            const list = document.getElementById('tabsList');
            list.innerHTML = '';
            Object.entries(categories).forEach(([id, name]) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'admin-tab' + (id === currentCatId ? ' active' : '');
                btn.textContent = name;
                btn.dataset.catId = id;
                btn.addEventListener('click', () => switchTab(id));
                list.appendChild(btn);
            });
            document.getElementById('noCategoryState').style.display = Object.keys(categories).length === 0 ? 'block' : 'none';
            document.getElementById('configCard').style.display = Object.keys(categories).length === 0 ? 'none' : 'block';
            document.getElementById('urlsCard').style.display = Object.keys(categories).length === 0 ? 'none' : 'block';
            document.getElementById('tabActions').style.display = currentCatId ? 'block' : 'none';
        }

        function switchTab(catId) {
            if (currentCatId && currentCatId !== catId) {
                saveConfigToCategory(currentCatId);
            }
            currentCatId = catId;
            renderTabs();
            loadConfig(catId);
            updateUrls();
        }

        function loadConfig(catId) {
            if (!catId) return;
            const path = `tournoi/categories/${catId}/config`;
            onValue(ref(db, path), (snapshot) => {
                if (currentCatId !== catId) return;
                const c = snapshot.val();
                document.getElementById('terrains').value = c?.nbTerrains ?? 2;
                document.getElementById('equipes').value = (c?.equipes && Array.isArray(c.equipes)) ? c.equipes.join('\n') : '';
                document.getElementById('arbitres').value = (c?.arbitres && Array.isArray(c.arbitres)) ? c.arbitres.join('\n') : '';
                document.getElementById('dureeMatch').value = c?.dureeMatch ?? '10 min';
            }, { onlyOnce: true });
        }

        function saveConfigToCategory(catId) {
            if (!catId) return;
            const config = {
                nbTerrains: parseInt(document.getElementById('terrains').value) || 2,
                equipes: document.getElementById('equipes').value.split('\n').filter(e => e.trim() !== ''),
                arbitres: document.getElementById('arbitres').value.split('\n').filter(a => a.trim() !== ''),
                dureeMatch: document.getElementById('dureeMatch').value || '10 min'
            };
            set(ref(db, `tournoi/categories/${catId}/config`), config);
        }

        function updateUrls() {
            const base = location.origin + location.pathname.replace('index.html','');
            const params = currentCatId ? '?cat=' + encodeURIComponent(currentCatId) : '';
            document.getElementById('urlGerant').textContent = base + 'gerant.html' + params;
            document.getElementById('urlCoach').textContent = base + 'coach.html' + params;
            document.getElementById('urlArbitre').textContent = base + 'arbitre.html' + params;
        }

        onValue(CATEGORY_LIST_REF, (snapshot) => {
            categories = snapshot.val() || {};
            if (!currentCatId && Object.keys(categories).length > 0) {
                currentCatId = Object.keys(categories)[0];
            }
            if (currentCatId && !categories[currentCatId]) {
                currentCatId = Object.keys(categories)[0] || null;
            }
            renderTabs();
            if (currentCatId) loadConfig(currentCatId);
            updateUrls();
        });

        document.querySelectorAll('[data-tpl]').forEach(btn => {
            btn.addEventListener('click', () => {
                const t = tpls[btn.dataset.tpl];
                document.getElementById('equipes').value = t.equipes;
                document.getElementById('terrains').value = t.terrains;
            });
        });

        document.getElementById('btnPreview').addEventListener('click', () => {
            const planning = previewTournoi();
            if (!planning) return alert("Besoin d'au moins 2 √©quipes !");
            const nbEq = [...new Set(planning.flatMap(m => [m.t1, m.t2]).filter(e => e !== "REPOS_FICTIF"))].length;
            const nbTours = Math.max(...planning.map(m => m.tour), 0);
            let html = `<p class="round-robin-info">${nbEq} √©quipes = ${planning.length} matchs en ${nbTours} tours.</p>`;
            let tourActuel = 0;
            planning.forEach(x => {
                if (x.tour !== tourActuel) {
                    tourActuel = x.tour;
                    html += `<div class="tour-header">TOUR ${tourActuel}</div>`;
                }
                html += `<div class="match-item"><span><b>T${x.terrain}</b> | ${x.t1} vs ${x.t2}</span><span class="duree">${x.duree}</span></div>`;
            });
            document.getElementById('previewBody').innerHTML = html;
            document.getElementById('previewModal').style.display = 'flex';
        });

        document.getElementById('closePreview').addEventListener('click', () => document.getElementById('previewModal').style.display = 'none');
        document.getElementById('previewModal').addEventListener('click', (e) => {
            if (e.target.id === 'previewModal') document.getElementById('previewModal').style.display = 'none';
        });

        document.getElementById('btnGenerer').addEventListener('click', () => {
            if (!currentCatId) return alert('S√©lectionnez une cat√©gorie.');
            genererTournoi(currentCatId);
        });

        document.getElementById('btnAddCat').addEventListener('click', () => {
            document.getElementById('newCatName').value = '';
            document.getElementById('addCatModal').style.display = 'flex';
            document.getElementById('newCatName').focus();
        });

        document.getElementById('cancelAddCat').addEventListener('click', () => document.getElementById('addCatModal').style.display = 'none');
        document.getElementById('addCatModal').addEventListener('click', (e) => {
            if (e.target.id === 'addCatModal') document.getElementById('addCatModal').style.display = 'none';
        });

        document.getElementById('confirmAddCat').addEventListener('click', () => {
            const name = document.getElementById('newCatName').value.trim();
            if (!name) return alert('Entrez un nom.');
            const id = slugify(name) || 'cat-' + Date.now();
            set(ref(db, `tournoi/categoryList/${id}`), name).then(() => {
                document.getElementById('addCatModal').style.display = 'none';
                switchTab(id);
            });
        });

        document.getElementById('btnDeleteCat').addEventListener('click', () => {
            if (!currentCatId || !confirm('Supprimer la cat√©gorie ¬´ ' + (categories[currentCatId] || '') + ' ¬ª ?')) return;
            remove(ref(db, `tournoi/categoryList/${currentCatId}`)).then(() => {
                remove(ref(db, `tournoi/categories/${currentCatId}`)).then(() => {
                    currentCatId = Object.keys(categories).filter(k => k !== currentCatId)[0] || null;
                    renderTabs();
                    if (currentCatId) loadConfig(currentCatId);
                });
            });
        });

        document.querySelectorAll('.btn-copy').forEach(btn => {
            btn.addEventListener('click', () => {
                const code = document.getElementById(btn.dataset.target);
                navigator.clipboard.writeText(code?.textContent || '').then(() => {
                    btn.textContent = '‚úì';
                    setTimeout(() => btn.textContent = 'Copier', 1500);
                });
            });
        });
    </script>
</body>
<!-- 54 69 6d e9 6f 20 43 48 41 52 56 4f 4c 49 4e 20 30 36 2f 30 32 2f 32 30 32 36 -->
</html>
